<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6" layout:decorate="~{layout}">

<head>
    <title layout:fragment="title">Post Detail</title>
</head>

<main layout:fragment="content">
    <h1 th:text="${post.title}"></h1>
    <p th:text="${post.content}"></p>

    <a th:href="@{/posts}" class="btn btn-secondary">Back To List</a>
    <span th:if="${post.user != null and loggedInUserId == post.user.id}">
        <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-primary">Edit</a>

        <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </span>

    <h2 class="mt-4">Comments</h2>

    <div class="mb-3" th:if="${post.comments} != null">
        <div th:each="comment : ${post.comments}">
            <div class="card mb-3">
                <div class="card-header">
                    <strong th:text="${comment.user.username}">Username</strong>
                    <small class="text-muted ms-2"
                        th:text="${#temporals.format(comment.createdAt, 'yyyy/MM/dd HH:mm:ss')}">Date</small>
                </div>
                <div class="card-body">
                    <p th:text="${comment.content}">Comment content</p>
                </div>
                <div class="card-footer">
                    <span th:if="${comment.user != null and loggedInUserId == comment.user.id}">
                        <!-- 自分のコメントか管理者だけ表示（任意） -->
                        <form th:action="@{/comments/{id}/delete(id=${comment.id})}" method="post"
                            style="display:inline;" sec:authorize="isAuthenticated()">
                            <input type="hidden" name="postId" th:value="${post.id}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mt-4">Add a Comment</h3>
    <form th:action="@{/comments/add}" method="post" sec:authorize="isAuthenticated()">
        <input type="hidden" name="postId" th:value="${post.id}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="mb-3">
            <textarea name="content" class="form-control" rows="3" placeholder="write a comment" required></textarea>
        </div>
        <button type="submit" class="btn btn-success">Add Comment</button>
    </form>
</main>

</html>